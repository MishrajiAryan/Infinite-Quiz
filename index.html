<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Infinite Quiz</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap 5 Dark Theme CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #181a1b;
            color: #e0e0e0;
        }
        .card {
            background: #23272b;
            border-radius: 18px;
            border: none;
            box-shadow: 0 2px 24px #0006;
        }
        .card-title {
            color: #00b4d8;
            letter-spacing: 1px;
        }
        #question-text {
            color: #fafafa !important;
            font-weight: 600;
            font-size: 1.25rem;
        }
        .option-btn {
            background: #23272b;
            color: #e0e0e0;
            border: 1px solid #343a40;
            border-radius: 12px !important;
            margin-bottom: 12px;
            font-size: 1.1rem;
            transition: background 0.3s, color 0.3s, border 0.3s;
        }
        .option-btn:hover, .option-btn:focus {
            background: #343a40;
            color: #fff;
        }
        .option-btn.correct {
            background: #198754 !important;
            color: #fff !important;
            border-color: #198754 !important;
        }
        .option-btn.incorrect {
            background: #dc3545 !important;
            color: #fff !important;
            border-color: #dc3545 !important;
        }
        .flagged-question {
            color: #ffb300;
            font-weight: bold;
        }
        #flag-btn.flagged {
            background: #ffb300;
            color: #23272b;
            border: none;
        }
        #flag-btn {
            transition: background 0.2s, color 0.2s;
        }
        #randomize-btn.active {
            background: #0077b6;
            color: #fff;
            border: none;
        }
        #randomize-btn {
            transition: background 0.2s, color 0.2s;
        }
        .question-meta {
            font-size: 1rem;
            color: #adb5bd;
        }
        .footer-note {
            color: #adb5bd;
        }
        @media (max-width: 600px) {
            .card { padding: 0.5rem; }
            .card-title { font-size: 1.3rem; }
            .option-btn { font-size: 1rem; }
        }
    </style>
</head>
<body>
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">
            <div class="card shadow-lg p-4">
                <div class="card-body">
                    <h3 class="card-title mb-4 text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="#00b4d8" class="me-2 mb-1" viewBox="0 0 16 16">
                          <path d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1zM2.5 8a5.5 5.5 0 1 1 11 0 5.5 5.5 0 0 1-11 0z"/>
                          <path d="M7.002 11h2v2h-2v-2zm.998-8a1 1 0 0 1 1 1v4a1 1 0 1 1-2 0V4a1 1 0 0 1 1-1z"/>
                        </svg>
                        Infinite Quiz
                    </h3>
                    <div id="question-area">
                        <div id="question-number" class="question-meta mb-2"></div>
                        <div id="question-text" class="mb-4"></div>
                        <div id="options-list" class="list-group mb-4"></div>
                    </div>
                    <div class="d-flex justify-content-between gap-2">
                        <button id="flag-btn" class="btn btn-outline-warning px-4 rounded-pill">Flag</button>
                        <button id="randomize-btn" class="btn btn-outline-info px-4 rounded-pill">Randomize</button>
                    </div>
                </div>
            </div>
            <div class="text-center mt-3 footer-note small">
                <span>Quiz never ends! Flag questions for review. Randomize order anytime.</span>
            </div>
        </div>
    </div>
</div>

<script>
let questions = [];
let order = [];
let current = 0;
let randomize = false;

// Fetch questions from backend
async function fetchQuestions() {
    try {
        const response = await fetch('/api/questions');
        questions = await response.json();
        order = [...Array(questions.length).keys()];
        current = 0;
        renderQuestion();
    } catch (err) {
        document.getElementById('question-area').innerHTML = "<div class='text-center text-danger'>Could not load questions.<br>Is the backend running?</div>";
    }
}

function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
}

function renderQuestion() {
    if (questions.length === 0) {
        document.getElementById('question-area').innerHTML = "<div class='text-center text-danger'>No questions found.</div>";
        return;
    }
    const qIndex = order[current];
    const q = questions[qIndex];

    document.getElementById('question-number').innerHTML =
        `<span>Question <b>${qIndex + 1}</b> of <b>${questions.length}</b></span>` +
        (q.flagged ? ' <span class="flagged-question ms-2">[Flagged]</span>' : '');

    document.getElementById('question-text').textContent = q.question;

    // Render options
    const optionsList = document.getElementById('options-list');
    optionsList.innerHTML = '';
    ['A','B','C','D'].forEach(letter => {
        const btn = document.createElement('button');
        btn.className = 'option-btn list-group-item list-group-item-action';
        btn.textContent = q['option_' + letter.toLowerCase()];
        btn.setAttribute('data-option', letter);
        btn.onclick = () => handleOptionClick(btn, q, letter);
        optionsList.appendChild(btn);
    });

    // Flag button state
    const flagBtn = document.getElementById('flag-btn');
    flagBtn.classList.toggle('flagged', q.flagged);
    flagBtn.textContent = q.flagged ? 'Unflag' : 'Flag';

    // Randomize button state
    const randomizeBtn = document.getElementById('randomize-btn');
    randomizeBtn.classList.toggle('active', randomize);
    randomizeBtn.textContent = randomize ? 'Unrandomize' : 'Randomize';
}

function handleOptionClick(btn, q, selected) {
    // Prevent clicking if already correct
    if (btn.classList.contains('correct')) return;

    // Disable all buttons after a correct answer
    if (selected === q.correct_option) {
        btn.classList.add('correct');
        // Disable all buttons except the correct one
        document.querySelectorAll('.option-btn').forEach(b => {
            b.disabled = true;
            if (b !== btn) {
                b.classList.remove('correct', 'incorrect');
            }
        });
        setTimeout(() => {
            nextQuestion();
        }, 1200);
    } else {
        btn.classList.add('incorrect');
        setTimeout(() => {
            btn.classList.remove('incorrect');
        }, 800);
    }
}

function nextQuestion() {
    current = (current + 1) % questions.length;
    renderQuestion();
}

// Flag/unflag the current question and persist to backend
document.getElementById('flag-btn').onclick = async function() {
    const qIndex = order[current];
    const q = questions[qIndex];
    const newFlagged = !q.flagged;

    // Update backend
    try {
        const response = await fetch(`/api/questions/${q.id}/flag`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({flagged: newFlagged})
        });
        const data = await response.json();
        if (data.success) {
            q.flagged = newFlagged;
            renderQuestion();
        } else {
            alert('Failed to update flag status.');
        }
    } catch (err) {
        alert('Error updating flag status.');
    }
};

document.getElementById('randomize-btn').onclick = function() {
    randomize = !randomize;
    if (randomize) {
        shuffle(order);
    } else {
        order = [...Array(questions.length).keys()];
    }
    current = 0;
    renderQuestion();
};

// Initial load
fetchQuestions();
</script>
</body>
</html>
